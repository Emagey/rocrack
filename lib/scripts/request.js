const savedMap=new Map,savedObject={},sendResponse=(a,r)=>{window.postMessage({type:a,details:r})},requests=[];let lastBool=!1;const scheduleRequest=(a,r)=>{requests.push({action:a,callback:r}),lastBool||(lastBool=!0,window.addEventListener("message",({data:t})=>{if(t.type==="request"){const{action:n,args:e}=t.details;requests.filter(s=>s?.action===n).forEach(s=>(s?.callback)(e))}}))},handleMap=async a=>{let r=savedMap.get(a.action)(a.args);r instanceof Promise&&(r=await r),sendResponse("SendGlobalResponse",{eventName:a.action,args:r})},addFunction=(a,r)=>{savedMap.set(a,r);const t=savedObject[a];t&&t.length>0&&t.forEach(n=>handleMap(n)),delete savedObject[a]},sendRequest=(a,r)=>{window.postMessage({type:"chromeRequest",details:{action:a,args:r}})};scheduleRequest("ChromeRequest",a=>{savedMap.has(a.action)?handleMap(a):(savedObject[a.action]||=[]).push(a)});function onSetAlways(a,r,t){const n=t(a[r])||a[r];return Object.defineProperty(a,r,{enumerable:!!a[r],configurable:!0,get:()=>n,set(e){delete a[r],a[r]=t(e)||e,onSetAlways(a,r,t)}}),()=>{const e=a[r];delete a[r],a[r]=e}}function onSet(a,r,t){return new Promise(n=>{if(!t&&a[r])return n(a[r]);Object.defineProperty(a,r,{enumerable:!1,configurable:!0,set(e){delete a[r],a[r]=e,n(e)}})})}async function getGlobals(a,r){let t=r.map(n=>onSet(a,n).then(e=>[n,e]));return Object.fromEntries(await Promise.all(t))}const copyGlobal=(a,r)=>{const t={};return Object.entries(a).forEach(([n,e])=>{typeof e=="function"||!r.includes(n)||(t[n]=e)}),t},every=async(a,r,t)=>{document.querySelectorAll(a).forEach(r);const n=new MutationObserver(e=>{if(!e[0]?.addedNodes?.length)return;const o=document.querySelectorAll(a);o.length&&o.length>(t||0)&&o.forEach(r)});return n.observe(document,{childList:!0,subtree:!0}),()=>n.disconnect()},find=async(a,r)=>{const t=document.querySelectorAll(a);return t.length&&t.length>(r||0)?r?t[r]:t:new Promise(n=>{const e=new MutationObserver(o=>{if(!o[0]?.addedNodes?.length)return;const s=document.querySelectorAll(a);s.length&&s.length>(r||0)&&(e.disconnect(),n(r?s[r]:s))});e.observe(document,{childList:!0,subtree:!0})})},first=async(a,r)=>new Promise(async t=>{const n=await find(a);r&&r(n[0]),t(n[0])});function waitForElementLoad(a){if(!(a.getAttribute("src")||a.hasAttribute("href")))return Promise.resolve();let r=!1,t;return a.addEventListener("load",()=>{r=!0,t?.()}),new Promise(n=>{if(r)return n();t=n})}function hijackFunction(a,r,t){a[r]=new Proxy(a[r],{apply:function(n,e,o){return typeof o[0]=="object"&&o[0]&&"passthrough"in o[0]&&"args"in o[0]?n.apply(e,o[0].args):t(o,s=>n.apply(e,o))}})}const accessoryAssetTypeIds=[8,41,42,43,44,45,46,47],menuToHash=a=>a.replaceAll(" ","-").toLowerCase(),method=async a=>{addFunction("Avatar.OverrideAssetTypeRestrictions",()=>{onSet(a.Roblox,"AvatarAccoutrementService").then(t=>{const n=t.addAssetToAvatar;t.addAssetToAvatar=(e,o,s)=>{const i=n(e,o,s);let u=10;return[e,...o].filter(d=>d.assetType?.id&&accessoryAssetTypeIds.includes(d.assetType.id)?u<=0?!1:(u--,!0):i.includes(d))}})}),addFunction("All.PromptGenericChallenge",t=>{if(!document.body.querySelector("#rgu-generic-challenge-container")){const n=document.createElement("div");n.id="rgu-generic-challenge-container",document.body.append(n)}return new Promise(n=>{window.Roblox?.AccountIntegrityChallengeService?.Generic?.interceptChallenge?.({challengeTypeRaw:t.challengeType,challengeId:t.challengeId,challengeMetadataJsonBase64:t.challengeBase64Metadata,containerId:"rgu-generic-challenge-container",retryRequest:(e,o)=>n({solved:!0,data:{challengeId:e,challengeBase64Metadata:o}})}).catch(()=>n({solved:!1}))})}),addFunction("All.Render3DThumbnail",t=>{const n=document.querySelector(t.selector);return n?onSet(window,"RobloxThumbnail3d").then(e=>e.thumbnail3dService?.getThumbnailJson?.(t.targetId).then(o=>{if(o?.json)return e?.thumbnail3dService?.loadObjAndMtl3D?.(t.targetId,n.parentElement,o.json)})).then(e=>{if(e)return n.append(e),!0}):!1}),addFunction("All.BlankCall",t=>{let n=window;for(const e of t.fn)if(n=n?.[e],!n)return;return n(...t.args||[])}),addFunction("Avatar.Initialize",()=>{let t,n=!1;const e=()=>{if(!t)return;const i=t.selectedMenu,u=t.selectedTab,l=t.selectedRow,d={tab:{name:u.name,label:u.name},subcategory:l&&{name:l.name,label:l.label},name:i.name,label:i.label};return i.bundleRecommendationType?d.detail={type:"Bundle",recommendationType:i.bundleRecommendationType}:i.assetType&&(d.detail={type:"Asset",assetType:t.getAssetTypeByName(i.assetType)}),d};addFunction("Avatar.GetActiveMenu",e);const o=()=>a.angular.element(".tab-pane.active [avatar-items]")?.scope(),s=location.hash.split("#!/")?.[1]?.split("/").map(menuToHash);return new Promise(i=>{every("#avatar-web-app .right-panel",u=>{const l=a.angular.element(u).scope();if(!l||l.rguModified)return;if(l.rguModified=!0,!n){if(n=!0,s){const y=l.tabs.find(c=>menuToHash(c.name)===s[0]);if(!y)return;let f,g;s.length===3&&y.categoryRows?(f=y.categoryRows.find(c=>menuToHash(c.name)===s[1]),g=f?.subCategoryMenu.find(c=>menuToHash(c.name)===s[2])):s.length===2&&y.subCategoryMenu&&(g=y.subCategoryMenu.find(c=>menuToHash(c.name)===s[1])),(g||f)&&l.onMenuClick(y,g,f)}i()}const d=l.onMenuClick;l.onMenuClick=(y,f,g)=>{const c=o();c&&(c.fullItems=void 0),window.location.hash=`#!/${menuToHash(y.name)}/${g?`${menuToHash(g.name)}/`:""}${menuToHash(f.name)}`;const p=d(y,f,g);return sendRequest("Avatar.MenuChanged",e()),p},t=l})})}),addFunction("All.InsertScripts",async t=>{const n=t.map(e=>{const o=document.createElement(e.tagName.toLowerCase());return Object.entries(e.attributes).forEach(([s,i])=>{o.setAttribute(s,i)}),e.text&&e.text.length>0&&(o.innerText=e.text),o});for(const e of n)(e.tagName==="LINK"&&e.getAttribute("rel")?.includes("stylesheet")||e?.innerText)&&document.body.append(e);for(const e of n)e.tagName==="SCRIPT"&&(document.body.append(e),await waitForElementLoad(e))});const r=(t,n)=>{onSet(a.Roblox,"RealTime").then(e=>onSet(e,"Factory")).then(e=>{e.GetClient().Subscribe(t,n)})};addFunction("All.SetupJoinRequest",t=>{onSet(a.Roblox,"Dialog").then(n=>{hijackFunction(n,"open",(e,o)=>{if(e?.[0]?.cssClass?.includes("protocolhandler")&&!e[0].bodyContent?.includes("Studio")){"onCloseCallback"in e[0]&&e[0].onCloseCallback();return}return o(e)})}),addFunction("All.SendJoinRequest",n=>{a.Roblox.GameLauncher[n.type]({passthrough:!0,args:n.args})}),onSet(a.Roblox,"GameLauncher").then(n=>{["joinGameInstance","joinMultiplayerGame","followPlayerIntoGame","joinPrivateGame","playTogetherGame"].forEach(e=>{hijackFunction(n,e,(o,s)=>{if(sendRequest("All.JoinRequest",{type:e,args:o}),!(["joinMultiplayerGame","joinPrivateGame"].includes(e)&&t.serverRegion))return s(o)})})}),r("GameCloseNotifications",()=>sendRequest("All.JoinedGame"))}),r("PresenceBulkNotifications",t=>sendRequest("All.UpdatePresences",t)),addFunction("Group.ViewLockedGroup",()=>new Promise(async t=>{let n=!1,e;every(".group-details-container-desktop-and-tablet",o=>{const s=a.angular.element(o).scope();if(s.rguModified)return;s.rguModified=!0,e=s.isLockedGroup.bind(s),s.isLockedGroup=()=>(e&&typeof e()=="boolean"&&!n&&(n=!1,t(e())),!1);const i=s.showJoinGroupButtonUI.bind(s);s.showJoinGroupButtonUI=()=>e?.()?!1:i();const u=s.canViewWall.bind(s);s.canViewWall=()=>e?.()?!1:u(),s.$apply()}),every("group-description div",o=>{const s=a.angular.element(o).scope();onSet(s.$ctrl,"layout",!0).then(i=>{i.loadError&&e?.()&&delete i.loadError})})})),addFunction("All.CurrentUser",async()=>{const t=copyGlobal(a.Roblox,["CurrentUser"]);return JSON.stringify(t)}),addFunction("All.OpenChat",async t=>{const n=await first("#chat-header");if(!n)return;const e=a.angular.element(n).scope();e&&(e.chatLibrary.chatLayout.collapsed=!1,e.$apply())}),addFunction("Home.GetFriendInfo",async()=>new Promise(async t=>{const n=await first(".people-list");if(!n)return t("Could not find element!");const e=a.angular.element(n).scope();if(!e)return t("Could not find scope!");const o=copyGlobal(e,["library"]);t(JSON.stringify(o))})),addFunction("Profile.GetPageData",async()=>new Promise(async t=>{const n=await first(".profile-about");if(!n)return t("Could not find element!");const e=a.angular.element(n).scope();if(!e)return t("Could not find scope!");const o=copyGlobal(e,["pageData"]);t(JSON.stringify(o))})),addFunction("Catalog.GetData",async()=>new Promise(async t=>{const n=await first("div[catalog-page]");if(!n)return;const e=a.angular.element(n).scope();if(!e)return;const o=copyGlobal(e,["data","queries","library"]);t(JSON.stringify(o))})),addFunction("Catalog.DisableInfiniteScrolling",async()=>{const t=document.querySelector("div[catalog-page]");if(!t)return;const n=a.angular.element(t).scope();n&&(n.infiniteScrollEnabled=!1,n.$apply())})};(async()=>getGlobals(window,["Roblox","angular"]).then(a=>method(a)).catch(a=>console.error(a)))();
